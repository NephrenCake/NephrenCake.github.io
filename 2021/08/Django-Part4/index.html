<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Django-Part4 | 浅幽丶奈芙莲的个人博客</title><meta name="author" content="NephrenCake"><meta name="copyright" content="NephrenCake"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="模型层">
<meta property="og:type" content="article">
<meta property="og:title" content="Django-Part4">
<meta property="og:url" content="https://nephrencake.gitee.io/2021/08/Django-Part4/index.html">
<meta property="og:site_name" content="浅幽丶奈芙莲的个人博客">
<meta property="og:description" content="模型层">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nephrencake.gitee.io/2021/08/Django-%E5%AE%8C%E7%BB%93%E7%9B%AE%E5%BD%95/%E4%BA%8Ced07.jpg">
<meta property="article:published_time" content="2021-08-12T14:31:23.000Z">
<meta property="article:modified_time" content="2021-10-26T15:09:02.568Z">
<meta property="article:author" content="NephrenCake">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nephrencake.gitee.io/2021/08/Django-%E5%AE%8C%E7%BB%93%E7%9B%AE%E5%BD%95/%E4%BA%8Ced07.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://nephrencake.gitee.io/2021/08/Django-Part4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-26 23:09:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/css/scrollbar.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="浅幽丶奈芙莲的个人博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">103</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-heart"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/2021/08/Django-%E5%AE%8C%E7%BB%93%E7%9B%AE%E5%BD%95/%E4%BA%8Ced07.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">浅幽丶奈芙莲的个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-heart"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Django-Part4</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-12T14:31:23.000Z" title="发表于 2021-08-12 22:31:23">2021-08-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-26T15:09:02.568Z" title="更新于 2021-10-26 23:09:02">2021-10-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Django/">Django</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Django-Part4——模型层"><a href="#Django-Part4——模型层" class="headerlink" title="Django-Part4——模型层"></a>Django-Part4——模型层</h1><p>[TOC]</p>
<h2 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h2><ul>
<li>当只是想测试django项目中的某一个.py文件内容，那么可以不用书写前后端交互的形式，而是直接写一个测试脚本即可。</li>
<li>脚本代码无论是写在应用下的tests.py，还是单独开设.py文件都可以。</li>
<li>django中的文件默认不会暴露出来，需要准备测试环境才能进行测试。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试环境的准备：1. 在manage.py中拷贝前四行代码；2. 额外增加两行代码</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    os.environ.setdefault(<span class="string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="string">&quot;djangoProject.settings&quot;</span>)  <span class="comment"># 这里要改成相应的项目名</span></span><br><span class="line">    <span class="keyword">import</span> django</span><br><span class="line">    django.setup()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试代码</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>当<code>from app01 import models</code>写在main之外时，可以通过勾选”使用Python控制台运行”来解决 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44393803/article/details/89739066">https://blog.csdn.net/weixin_44393803/article/details/89739066</a></p>
</li>
<li><p>当不准备环境配置时，可以在运行配置中勾选 Python控制台启动 。这样会忽略脚本中的配置环境代码。（推荐）</p>
</li>
</ul>
<h2 id="Django-ORM"><a href="#Django-ORM" class="headerlink" title="Django ORM"></a>Django ORM</h2><h3 id="创建模型表"><a href="#创建模型表" class="headerlink" title="创建模型表"></a>创建模型表</h3><ul>
<li>对象关系映射（ORM），能够以面向对象的方式简便快捷地操作数据库。但是封装程度太高，有时候还是需要自己写SQL语句。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -&gt; app -&gt; models.py</span></span><br><span class="line"><span class="comment"># 1. 首先在models.py中书写一个类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="comment"># id int primary_key auto_increment</span></span><br><span class="line">    <span class="built_in">id</span> = models.AutoField(primary_key=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;主键&#x27;</span>)  <span class="comment"># verbose_name用来对字段解释</span></span><br><span class="line">    <span class="comment"># username varchar(32)</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>, verbose_name=<span class="string">&#x27;用户名&#x27;</span>)  <span class="comment"># CharField必须要指定max_length参数，否则报错</span></span><br><span class="line">    <span class="comment"># password int</span></span><br><span class="line">    password = models.IntegerField(verbose_name=<span class="string">&#x27;密码&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="comment"># 由于一张表中必须要有一个主键字段，并且一般情况下都叫id字段</span></span><br><span class="line">    <span class="comment"># 所以当不定义主键字段时，orm会自动创建一个名为id主键字段</span></span><br><span class="line">    <span class="comment"># 也就意味着：后续在创建表时，如果主键字段名没有额外的叫法，那么主键字段可以省略不写</span></span><br><span class="line">    <span class="comment"># username varchar(32)</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="comment"># password int</span></span><br><span class="line">    password = models.IntegerField()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>每次只要修改了models.py中跟数据库相关的代码，就必须重新执行以下两条命令。</li>
<li>如果发现执行之后没有发生变化，则检查app是否已经注册</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -&gt; 控制台</span></span><br><span class="line"><span class="comment"># 2. 数据库迁移命令</span></span><br><span class="line">python manage.py makemigrations  <span class="comment"># 将操作记录记录migrations文件夹中</span></span><br><span class="line">python manage.py migrate  <span class="comment"># 将操作真正的同步到数据库中</span></span><br></pre></td></tr></table></figure>
<ul>
<li>除自建表之外，还有Django需要使用的表</li>
</ul>
<p><img src="/2021/08/Django-Part4/image-20210616153539184.png" alt="image-20210616153539184"></p>
<h3 id="字段的增-删-改"><a href="#字段的增-删-改" class="headerlink" title="字段的增/删/改"></a>字段的增/删/改</h3><ul>
<li><p>当数据表拥有记录时，不能增加非空字段：</p>
<ol>
<li>在终端内直接给出默认值</li>
<li>退出终端程序，并修改代码为可以为空<code>xxx = models.CharField(max_length=32, null=True)</code></li>
<li>退出终端程序，并修改代码设置默认值<code>xxx = models.CharField(max_length=32, default=&#39;xxx&#39;)</code></li>
</ol>
</li>
<li><p>修改字段则是修改对应代码</p>
</li>
<li><p>删除字段则是注释/删除对应代码</p>
</li>
</ul>
<p>修改model文件之后，不要忘了执行数据库迁移的两条命令</p>
<blockquote>
<p>不要轻易地删除/注释字段，删除也最好使用软删除！</p>
<p>在对于数据库操作时一定要注意隐私安全，一定要锁屏！</p>
</blockquote>
<h3 id="创建表关系"><a href="#创建表关系" class="headerlink" title="创建表关系"></a>创建表关系</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建表关系。先将基表创建出来，然后再添加外键字段</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>, verbose_name=<span class="string">&quot;书名&quot;</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">8</span>, decimal_places=<span class="number">2</span>)  <span class="comment"># 总共八位 小数点后面占两位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 图书和出版社是一对多，并且书是多的一方，所以外键字段放在书表里面</span></span><br><span class="line">    publish = models.ForeignKey(to=<span class="string">&#x27;Publish&#x27;</span>, on_delete=models.CASCADE)</span><br><span class="line">    <span class="comment"># to_field=默认与出版社表的主键字段做外键关联</span></span><br><span class="line">    <span class="comment"># 如果该字段是ForeignKey，则orm会自动在字段的后面加 _id -&gt; publish_id</span></span><br><span class="line">    <span class="comment"># 因此在定义ForeignKey的时候就不要加 _id</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 图书和作者是多对多的关系，外键字段建在任意一方均可，但是推荐建在查询频率较高的一方</span></span><br><span class="line">    authors = models.ManyToManyField(to=<span class="string">&#x27;Author&#x27;</span>)</span><br><span class="line">    <span class="comment"># authors是一个虚拟字段 主要是用来告诉orm 书籍表和作者表是多对多关系</span></span><br><span class="line">    <span class="comment"># orm将自动创建第三张关系表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publish</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    addr = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    age = models.IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 作者与作者详情是一对一的关系 外键字段建在任意一方都可以 但是推荐你建在查询频率较高的表中</span></span><br><span class="line">    author_detail = models.OneToOneField(to=<span class="string">&#x27;AuthorDetail&#x27;</span>, on_delete=models.CASCADE)  <span class="comment"># django2.x之后要手动添加级联删除</span></span><br><span class="line">    <span class="comment"># OneToOneField()也会自动给字段 author_detail 加 _id 后缀</span></span><br><span class="line">    <span class="comment"># on_delete有CASCADE、PROTECT、SET_NULL、SET_DEFAULT、SET(value)五个可选择的值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorDetail</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    phone = models.BigIntegerField()  <span class="comment"># 直接用字符类型更好</span></span><br><span class="line">    addr = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>A表外键字段 = models.ForeignKey(to=B表)</code> </li>
<li><code>关系表外键字段 = models.ManyToManyField(to=B表)</code> </li>
<li><code>A表外键字段 = models.OneToOneField(to=B表)</code> </li>
</ul>
<blockquote>
<p>外键都会自动加_id后缀</p>
</blockquote>
<h2 id="单表操作"><a href="#单表操作" class="headerlink" title="单表操作"></a>单表操作</h2><h3 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h3><ul>
<li>在视图函数中，<code>from app01 import models</code>首先导入对应的app下的model</li>
<li>django自带的sqlite3数据库对日期格式不是很敏感，处理的时候容易出错。</li>
<li>pk会自动查找到当前表的主键字段，指代的就是当前表的主键字段，避免区分当前表的主键字段名uid/pid/sid</li>
</ul>
<h4 id="增"><a href="#增" class="headerlink" title="增"></a>增</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line">        <span class="comment"># 第一种方式(推荐使用)</span></span><br><span class="line">		reslt = models.User.objects.create(username=username, password=password)  </span><br><span class="line">        print(res, res.username, res.password)  <span class="comment"># 返回值就是当前被创建的对象本身</span></span><br><span class="line">        <span class="comment"># 第二种方式</span></span><br><span class="line">		user_obj = models.User(username=username, password=password)</span><br><span class="line">		user_obj.save()  <span class="comment"># 保存数据</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 先给用户返回一个注册页面</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;reg.html&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="查"><a href="#查" class="headerlink" title="查"></a>查</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取用户的用户名和密码 然后利用orm操作数据 校验数据是否正确</span></span><br><span class="line">        username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 去数据库中查询数据</span></span><br><span class="line">        <span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line">        <span class="comment"># select * from user where username=&#x27;jason&#x27;;</span></span><br><span class="line">        <span class="comment"># filter相当于where，括号内可以携带多个参数，参数与参数之间是and关系</span></span><br><span class="line">        result = models.User.objects.<span class="built_in">filter</span>(username=username)</span><br><span class="line">        print(<span class="built_in">type</span>(result))  <span class="comment"># &lt;QuerySet [&lt;User: User object&gt;]&gt;</span></span><br><span class="line">		<span class="comment"># 支持索引取值、切片操作，但是不支持负数索引</span></span><br><span class="line">		user_obj = reslt.first()  <span class="comment"># 从queryset拿出一个个数据对象</span></span><br><span class="line">		print(user_obj.username)  <span class="comment"># 直接调用字段</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 比对密码是否一致</span></span><br><span class="line">        <span class="keyword">if</span> user_obj:</span><br><span class="line">            <span class="keyword">if</span> password == user_obj.password:</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">&quot;登陆成功&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">&quot;密码错误&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;login.html&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>models.User.objects.filter()</code>等效于<code>models.User.objects.all()</code></li>
<li><code>.first()</code>等效于<code>[0]</code></li>
</ul>
<p>数据展示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -&gt; views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">userlist</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 查询出用户表里面所有的数据</span></span><br><span class="line">    user_queryset = models.User.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="comment"># return render(request,&#x27;userlist.html&#x27;,&#123;&#x27;user_queryset&#x27;:user_queryset&#125;)</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;userlist.html&#x27;</span>, <span class="built_in">locals</span>())  <span class="comment"># 返回当前的命名空间</span></span><br></pre></td></tr></table></figure>
<p>模板语法for：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for user_obj in user_queryset %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; user_obj.id &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; user_obj.username &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; user_obj.password &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">&#123;#            利用url问号后面携带参数的方式，将编辑按钮所在行的主键值发送给后端#&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/edit_user/?user_id=&#123;&#123; user_obj.id &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary btn-xs&quot;</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/delete_user/?user_id=&#123;&#123; user_obj.id &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger btn-xs&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<h4 id="改"><a href="#改" class="headerlink" title="改"></a>改</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_user</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 获取url问号后面的参数</span></span><br><span class="line">    edit_id = request.GET.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">    <span class="comment"># 查询当前用户想要编辑的数据对象</span></span><br><span class="line">    edit_list = models.User.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=edit_id)</span><br><span class="line">    edit_obj = edit_list.first()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="comment"># 改 1 批量更新filter查询出来的列表中所有对象。只修改被修改的字段</span></span><br><span class="line">        edit_list.update(username=username, password=password)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 改 2 单条数据更新。无论该字段是否被修改，重写所有字段(当字段特别多时，效率很低)</span></span><br><span class="line">        edit_obj.username = username</span><br><span class="line">        edit_obj.password = password</span><br><span class="line">        edit_obj.save()</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/userlist/&#x27;</span>)  <span class="comment"># 跳转到数据的展示页面</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;edit_user.html&#x27;</span>, <span class="built_in">locals</span>())  <span class="comment"># 将数据对象展示到页面上</span></span><br></pre></td></tr></table></figure>
<h4 id="删"><a href="#删" class="headerlink" title="删"></a>删</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_user</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 获取用户想要删除的数据id值</span></span><br><span class="line">    delete_id = request.GET.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">    <span class="comment"># 删 1 批量删除数据库中找到对应的数据</span></span><br><span class="line">    res = models.User.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=delete_id).delete()</span><br><span class="line">    print(res)  <span class="comment"># (1, &#123;&#x27;app01.User&#x27;: 1&#125;)</span></span><br><span class="line">    <span class="comment"># 删 2</span></span><br><span class="line">    user_obj = models.User.objects.<span class="built_in">filter</span>(pk=delete_id).first()</span><br><span class="line">    user_obj.delete()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;/userlist/&#x27;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一般都会添加一个is_delete字段做软删除，而不会直接删除。</p>
</blockquote>
<h3 id="必知必会13条"><a href="#必知必会13条" class="headerlink" title="必知必会13条"></a>必知必会13条</h3><ol>
<li><p>all()：查询所有数据</p>
</li>
<li><p>filter()：带有过滤条件的查询</p>
</li>
<li><p>get()：直接拿数据对象，但是条件不存在直接报错</p>
</li>
<li><p>first()：拿queryset里面第一个元素</p>
</li>
<li><p>last()：拿queryset里面最后一个元素</p>
</li>
<li><p>values()：可以指定获取的数据字段，相当于select name,age from …     </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.values(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">print(res)  <span class="comment"># 列表套字典 &lt;QuerySet [&#123;&#x27;name&#x27;: &#x27;jason&#x27;, &#x27;age&#x27;: 18&#125;, &#123;&#x27;name&#x27;: &#x27;egonPPP&#x27;, &#x27;age&#x27;: 84&#125;]&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>values_list()：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.values_list(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">print(res)  <span class="comment"># 列表套元组 &lt;QuerySet [(&#x27;jason&#x27;, 18), (&#x27;egonPPP&#x27;, 84)]&gt;</span></span><br></pre></td></tr></table></figure>
<p>和values()仅仅只是封装格式不一样，sql查询语句是一样的。</p>
</li>
<li><p>distinct()：去重</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.values(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;age&#x27;</span>).distinct()</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>去重一定要是（在虚表中）一模一样的数据。</p>
<p>例如：.all()的数据带有主键，因此无法去重</p>
</li>
</ul>
</li>
<li><p>order_by()：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.order_by(<span class="string">&#x27;age&#x27;</span>)  <span class="comment"># 默认升序</span></span><br><span class="line">res = models.User.objects.order_by(<span class="string">&#x27;-age&#x27;</span>)  <span class="comment"># 降序</span></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure></li>
<li><p>reverse()：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.<span class="built_in">all</span>()  <span class="comment"># 反转</span></span><br><span class="line">res1 = models.User.objects.order_by(<span class="string">&#x27;age&#x27;</span>).reverse()  <span class="comment"># 必须先排序</span></span><br><span class="line">print(res, res1)</span><br></pre></td></tr></table></figure></li>
<li><p>count()：统计当前数据的个数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.count()  <span class="comment"># 统计当前数据的个数</span></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure></li>
<li><p>exclude()：排除在外</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.exclude(name=<span class="string">&#x27;jason&#x27;</span>)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure></li>
<li><p>exists()：基本用不到因为数据本身就自带布尔值  返回的是布尔值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.User.objects.<span class="built_in">filter</span>(pk=<span class="number">10</span>).exists()</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<h3 id="查看内部sql语句的方式"><a href="#查看内部sql语句的方式" class="headerlink" title="查看内部sql语句的方式"></a>查看内部sql语句的方式</h3></li>
<li><p>只有QuerySet类对象可以使用.query查看内部封装的sql语句</p>
</li>
<li><p>在配置文件中配置logging，查看所有的sql语句</p>
</li>
<li><p>需要在Python控制台中运行才能看见</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1</span></span><br><span class="line">res = models.User.objects.values_list(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">print(res.query)  <span class="comment"># SELECT `app01_user`.`name`, `app01_user`.`age` FROM `app01_user`</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2</span></span><br><span class="line"><span class="comment"># -&gt; settings.py</span></span><br><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&#x27;version&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;disable_existing_loggers&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;handlers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;console&#x27;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>:<span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>:<span class="string">&#x27;logging.StreamHandler&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;loggers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;django.db.backends&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;handlers&#x27;</span>: [<span class="string">&#x27;console&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;propagate&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>:<span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="双下划线查询"><a href="#双下划线查询" class="headerlink" title="双下划线查询"></a>双下划线查询</h3><ul>
<li>__gt: 大于</li>
<li>__gte: 大于等于</li>
<li>__lt: 小于</li>
<li>__lte: 小于等于</li>
<li>__in: 在目标集合中，左右闭区间</li>
<li>__range: 在目标范围中</li>
<li>__contains: 模糊查询，包含（区分大小写）</li>
<li>__icontains: 包含（不区分大小写）</li>
<li>__startswith: 以某字符开头</li>
<li>__endswith: 以某字符结尾</li>
<li>__month: 在目标月份</li>
<li>__year: 在目标年份</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 年龄大于35岁的数据</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(age__gt=<span class="number">35</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 年龄小于35岁的数据</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(age__lt=<span class="number">35</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 大于等于 小于等于</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(age__gte=<span class="number">32</span>)</span><br><span class="line">print(res)</span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(age__lte=<span class="number">32</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 年龄是 18 或者 32 或者 40</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(age__in=[<span class="number">18</span>, <span class="number">32</span>, <span class="number">40</span>])</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 年龄在18到40岁之间的  首尾都要</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(age__range=[<span class="number">18</span>, <span class="number">40</span>])</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 查询出名字里面含有s的数据  模糊查询</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(name__contains=<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 是否区分大小写  查询出名字里面含有p的数据  区分大小写</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(name__contains=<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 忽略大小写</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(name__icontains=<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 开头结尾 </span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(name__startswith=<span class="string">&#x27;j&#x27;</span>)</span><br><span class="line">res1 = models.User.objects.<span class="built_in">filter</span>(name__endswith=<span class="string">&#x27;j&#x27;</span>)</span><br><span class="line">print(res, res1)</span><br><span class="line"><span class="comment"># 查询出注册时间是 2020 1月</span></span><br><span class="line">res = models.User.objects.<span class="built_in">filter</span>(register_time__month=<span class="string">&#x27;1&#x27;</span>, register_time__year=<span class="string">&#x27;2020&#x27;</span>)</span><br><span class="line">res = res.<span class="built_in">filter</span>(register_time__year=<span class="string">&#x27;2020&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="一对多外键增删改查"><a href="#一对多外键增删改查" class="headerlink" title="一对多外键增删改查"></a>一对多外键增删改查</h3><ul>
<li><p>增 create(): publish_id=num或者publish=publish_obj</p>
</li>
<li><p>删 filter(pk=pk).delete(): 会按照on_delete处理对应外键</p>
</li>
<li><p>改 filter(pk=pk).update(): publish_id=num或者publish=publish_obj</p>
<p>这是批量修改，在first()返回的对象中没有update这个方法</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一对多增删改查</span></span><br><span class="line"><span class="comment"># 1. 增</span></span><br><span class="line"><span class="comment"># 直接写实际字段 id</span></span><br><span class="line">models.Book.objects.create(title=<span class="string">&#x27;三国演义&#x27;</span>, price=<span class="number">123.23</span>, publish_id=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 投放虚拟字段 对象</span></span><br><span class="line">publish_obj = models.Publish.objects.<span class="built_in">filter</span>(pk=<span class="number">2</span>).first()</span><br><span class="line">models.Book.objects.create(title=<span class="string">&quot;红楼梦&quot;</span>, price=<span class="number">666.23</span>, publish=publish_obj)</span><br><span class="line"><span class="comment"># 2. 删</span></span><br><span class="line">models.Publish.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).delete()  <span class="comment"># 会按照on_delete处理对应外键</span></span><br><span class="line"><span class="comment"># 3. 改</span></span><br><span class="line">models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).update(publish_id=<span class="number">2</span>)</span><br><span class="line">publish_obj = models.Publish.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).first()</span><br><span class="line">models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).update(publish=publish_obj)</span><br></pre></td></tr></table></figure>
<h3 id="多对多外键增删改查"><a href="#多对多外键增删改查" class="headerlink" title="多对多外键增删改查"></a>多对多外键增删改查</h3><ul>
<li><p>models.表名.objects.filter(pk=条件).first().多对多关系.add()</p>
<p>方法支持传递主键，也可以传递对象</p>
</li>
<li><p>models.表名.objects.filter(pk=条件).first().多对多关系.remove()</p>
<p>这只是在第三张关系表中删除记录</p>
</li>
<li><p>models.表名.objects.filter(pk=条件).first().多对多关系.set()</p>
<p>括号内必须给一个可迭代对象</p>
<p>如果不符合要求，则先删除，后新增</p>
</li>
<li><p>models.表名.objects.filter(pk=条件).first().多对多关系.clear()</p>
<p>在第三张关系表中清空某个书籍与作者的绑定关系</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 增加关系</span></span><br><span class="line">   <span class="comment"># 给书籍添加作者</span></span><br><span class="line">   book_obj = models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).first()</span><br><span class="line">   print(book_obj.authors)  <span class="comment"># 就类似于你已经到了Book和Authors的多对多关系表了</span></span><br><span class="line">   book_obj.authors.add(<span class="number">1</span>)  <span class="comment"># 书籍id为1的书籍绑定一个主键为1的作者</span></span><br><span class="line">   book_obj.authors.add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">   author_obj = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).first()</span><br><span class="line">   author_obj1 = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">2</span>).first()</span><br><span class="line">   author_obj2 = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">3</span>).first()</span><br><span class="line">   book_obj.authors.add(author_obj)</span><br><span class="line">   book_obj.authors.add(author_obj1, author_obj2)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 2. 删</span></span><br><span class="line">   book_obj.authors.remove(<span class="number">2</span>)</span><br><span class="line">   book_obj.authors.remove(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">   author_obj = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">2</span>).first()</span><br><span class="line">   author_obj1 = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">3</span>).first()</span><br><span class="line">   book_obj.authors.remove(author_obj, author_obj1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 改</span></span><br><span class="line">   book_obj.authors.<span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line">   book_obj.authors.<span class="built_in">set</span>([<span class="number">3</span>])  <span class="comment"># 括号内必须给一个可迭代对象</span></span><br><span class="line"></span><br><span class="line">   author_obj = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">2</span>).first()</span><br><span class="line">   author_obj1 = models.Author.objects.<span class="built_in">filter</span>(pk=<span class="number">3</span>).first()</span><br><span class="line">   book_obj.authors.<span class="built_in">set</span>([author_obj, author_obj1])  <span class="comment"># 支持多个</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 4. 清空</span></span><br><span class="line">   book_obj.authors.clear()</span><br><span class="line">   book_obj.authors.<span class="built_in">set</span>([])</span><br></pre></td></tr></table></figure>
<h2 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h2><h3 id="正反向"><a href="#正反向" class="headerlink" title="正反向"></a>正反向</h3><ul>
<li>当a表中拥有b表的外键字段，则a查b为正向，否则反向。</li>
<li>一对一和多对多正反向的判断也是如此</li>
</ul>
<p>外键字段要放在查询频率高的表中。</p>
<blockquote>
<ul>
<li>正向查询按 <code>字段</code> </li>
<li>反向查询<ul>
<li>查询一对多、多对多时按 <code>表名小写+_set</code> </li>
<li>查询一对一时按 <code>表名小写</code></li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="子查询-基于对象的跨表查询"><a href="#子查询-基于对象的跨表查询" class="headerlink" title="子查询(基于对象的跨表查询)"></a>子查询(基于对象的跨表查询)</h3><p>在书写orm语句的时候跟写sql语句一样的：</p>
<ul>
<li>不要企图一次性将orm语句写完，如果比较复杂，就写一点看一点</li>
</ul>
<blockquote>
<p>正向什么时候需要加.all()：</p>
<ul>
<li>查询 多对多 和 一对多 关系时需要加</li>
<li>查询 一对一 和 多对一 关系时不需要</li>
<li>当为需要all()的情况时，即使结果只有一个，也会返回集合</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查询主键为1的书籍的出版社</span></span><br><span class="line">   <span class="comment"># 有字段 -&gt; 正向；查询多对一关系中一的一方 -&gt; 不用.all()</span></span><br><span class="line">   book_obj = models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).first()</span><br><span class="line">   res = book_obj.publish</span><br><span class="line">   print(res.name)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 2. 查询主键为2的书籍的作者</span></span><br><span class="line">   <span class="comment"># 有字段 -&gt; 正向；多对多关系 -&gt; 要.all()</span></span><br><span class="line">   book_obj = models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).first()</span><br><span class="line">   res = book_obj.authors</span><br><span class="line">   print(res)</span><br><span class="line">   <span class="comment"># app01.Author.None</span></span><br><span class="line">   print(res.<span class="built_in">all</span>())</span><br><span class="line">   <span class="comment"># &lt;QuerySet [&lt;Author: Author object (1)&gt;, &lt;Author: Author object (3)&gt;]&gt;</span></span><br><span class="line">   print(models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">3</span>).first().authors.<span class="built_in">all</span>())</span><br><span class="line">   <span class="comment"># &lt;QuerySet [&lt;Author: Author object (1)&gt;]&gt;</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 3. 查询作者jason的电话号码</span></span><br><span class="line">   <span class="comment"># 有字段 -&gt; 正向；一对一关系 -&gt; 不用.all()</span></span><br><span class="line">   author_obj = models.Author.objects.<span class="built_in">filter</span>(name=<span class="string">&quot;jason&quot;</span>).first()</span><br><span class="line">   res = author_obj.author_detail</span><br><span class="line">   print(res.phone, res.addr)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 4. 查询出版社是东方出版社出版的书</span></span><br><span class="line">   <span class="comment"># 无字段 -&gt; 反向；查询一对多关系中多的一方 -&gt; 要.all()</span></span><br><span class="line">   publish_obj = models.Publish.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;东方出版社&#x27;</span>).first()</span><br><span class="line">   res = publish_obj.book_set  <span class="comment"># app01.Book.None</span></span><br><span class="line">   res = publish_obj.book_set.<span class="built_in">all</span>()</span><br><span class="line">   print(res)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 5. 查询作者jason写过的书</span></span><br><span class="line">   <span class="comment"># 无字段 -&gt; 反向；多对多关系 -&gt; 要.all()</span></span><br><span class="line">   author_obj = models.Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;jason&#x27;</span>).first()</span><br><span class="line">   res = author_obj.book_set  <span class="comment"># app01.Book.None</span></span><br><span class="line">   res = author_obj.book_set.<span class="built_in">all</span>()</span><br><span class="line">   print(res)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 6.查询手机号是110的作者姓名</span></span><br><span class="line">   <span class="comment"># 无字段 -&gt; 反向；一对一关系 -&gt; 不用.all()，不用_set</span></span><br><span class="line">   author_detail_obj = models.AuthorDetail.objects.<span class="built_in">filter</span>(phone=<span class="number">110</span>).first()</span><br><span class="line">   res = author_detail_obj.author</span><br><span class="line">   print(res.name)</span><br></pre></td></tr></table></figure>
<h3 id="联表查询-基于双下划线的跨表查询"><a href="#联表查询-基于双下划线的跨表查询" class="headerlink" title="联表查询(基于双下划线的跨表查询)"></a>联表查询(基于双下划线的跨表查询)</h3><ul>
<li>QuerySet要先用int取字典，再用key取对应的数据</li>
<li>可以放多个查询的键</li>
<li>__就是用来获得表下的一个字段</li>
<li>而写到__之前则表示已经进入了另外一个表</li>
<li>这里非对象时都不需要_set</li>
<li>可以 __ id 或者 __pk，是等价的</li>
<li>可以无限制的跨表，正向、反向</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查询jason的手机号和作者姓名</span></span><br><span class="line"><span class="comment"># 有字段 -&gt; 正向；</span></span><br><span class="line">res = models.Author.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;jason&#x27;</span>).values(<span class="string">&quot;author_detail__phone&quot;</span>, <span class="string">&quot;name&quot;</span>)</span><br><span class="line">print(res[<span class="number">0</span>][<span class="string">&quot;author_detail__phone&quot;</span>])</span><br><span class="line"><span class="comment"># 反向</span></span><br><span class="line">res = models.AuthorDetail.objects.<span class="built_in">filter</span>(author__name=<span class="string">&#x27;jason&#x27;</span>)  <span class="comment"># 拿作者姓名是jason的作者详情</span></span><br><span class="line">res = models.AuthorDetail.objects.<span class="built_in">filter</span>(author__name=<span class="string">&#x27;jason&#x27;</span>).values(<span class="string">&#x27;phone&#x27;</span>, <span class="string">&#x27;author__name&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查询书籍主键为1的出版社名称和书的名称</span></span><br><span class="line"><span class="comment"># 正向，写到publish时就已经到了publish表，主需要__来取这个表下的任意字段</span></span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).values(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;publish__name&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 反向</span></span><br><span class="line">res = models.Publish.objects.<span class="built_in">filter</span>(book__pk=<span class="number">1</span>).values(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;book__title&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查询书籍主键为1的作者姓名</span></span><br><span class="line"><span class="comment"># 正向</span></span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).values(<span class="string">&#x27;authors__name&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># 反向</span></span><br><span class="line">res = models.Author.objects.<span class="built_in">filter</span>(book__id=<span class="number">1</span>).values(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 查询书籍主键是1的作者的手机号</span></span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).values(<span class="string">&quot;authors__author_detail__phone&quot;</span>)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<h3 id="聚合查询-aggregate"><a href="#聚合查询-aggregate" class="headerlink" title="聚合查询(aggregate)"></a>聚合查询(aggregate)</h3><ul>
<li>只要是跟数据库相关的模块，基本上都在django.db.models里面，如果没有则应该在django.db里面。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Max,Min,Sum,Count,Avg</span><br><span class="line">res = models.Book.objects.aggregate(Max(<span class="string">&#x27;price&#x27;</span>),Min(<span class="string">&#x27;price&#x27;</span>),Sum(<span class="string">&#x27;price&#x27;</span>),Count(<span class="string">&#x27;pk&#x27;</span>),Avg(<span class="string">&#x27;price&#x27;</span>))</span><br><span class="line">print(res)</span><br><span class="line"><span class="comment"># &#123;&#x27;price__max&#x27;: Decimal(&#x27;899.23&#x27;), &#x27;price__min&#x27;: Decimal(&#x27;123.23&#x27;), &#x27;price__sum&#x27;: Decimal(&#x27;2466.58&#x27;), &#x27;pk__count&#x27;: 5, &#x27;price__avg&#x27;: Decimal(&#x27;493.316000&#x27;)&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="分组查询-annotate"><a href="#分组查询-annotate" class="headerlink" title="分组查询(annotate)"></a>分组查询(annotate)</h3><ul>
<li>MySQL分组查询特点：分组之后默认只能获取到分组的依据，组内其他字段都无法直接获取了(严格模式，ONLY_FULL_GROUP_BY)</li>
<li>author和author__pk是等价的，个人认为写全更好</li>
<li>models后面点什么，就是按什么分组</li>
<li>author_num是自己定义的临时字段，用来存储统计出来的每本书对应的作者个数</li>
<li>在使用values创建虚表时，依然可以放入多个字段</li>
<li>只要orm语句得出的结果还是一个queryset对象，那么就可以继续无限制的点queryset对象封装的方法</li>
<li>queryset对象就代表一个虚表</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 统计每一本书的作者个数</span></span><br><span class="line">   <span class="comment"># 只需要写author就可以了</span></span><br><span class="line">   <span class="comment"># models后面点什么，就是按什么分组</span></span><br><span class="line">   <span class="comment"># author_num是我们自己定义的字段，用来存储统计出来的每本书对应的作者个数</span></span><br><span class="line">   <span class="comment"># 在使用values创建虚表时，依然可以放入多个字段 	</span></span><br><span class="line">   res = models.Book.objects.annotate(author_num=Count(<span class="string">&quot;author__pk&quot;</span>)).values(<span class="string">&quot;author_num&quot;</span>, <span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;author_num&#x27;</span>)</span><br><span class="line">   print(res)</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 2. 统计每个出版社卖的最便宜的书的价格</span></span><br><span class="line">   <span class="comment"># 按publish分组，反向找book表中price的最小值，作为publish表的min_price临时字段</span></span><br><span class="line">   res = models.Publish.objects.annotate(min_price=Min(<span class="string">&#x27;book__price&#x27;</span>)).values(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;min_price&#x27;</span>)</span><br><span class="line">   print(res)</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 3. 统计不止一个作者的图书</span></span><br><span class="line">   <span class="comment"># 先按照图书分组，求每一本书对应的作者个数</span></span><br><span class="line">   <span class="comment"># 过滤出不止一个作者的图书</span></span><br><span class="line">   res = models.Book.objects.annotate(author_num=Count(<span class="string">&quot;author_id&quot;</span>)) \</span><br><span class="line">       .<span class="built_in">filter</span>(author__num__gt=<span class="number">1</span>) \</span><br><span class="line">       .values(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;author_num&#x27;</span>)</span><br><span class="line">   <span class="comment"># 只要orm语句得出的结果还是一个queryset对象，那么就可以继续无限制的点queryset对象封装的方法</span></span><br><span class="line">   <span class="comment"># queryset对象就代表一个虚表</span></span><br><span class="line">   print(res)</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 4. 查询每个作者出的书的总价格</span></span><br><span class="line">   res = models.Author.objects.annotate(sum_price=Sum(<span class="string">&#x27;book__price&#x27;</span>)).values(<span class="string">&#x27;name&#x27;</span>, <span class="string">&quot;sum_price&quot;</span>)</span><br><span class="line">   print(res)</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># 5. 按照指定的字段分组，本质也是创造虚表</span></span><br><span class="line">   models.Book.objects.values(<span class="string">&#x27;price&#x27;</span>).annotate()</span><br></pre></td></tr></table></figure>
<h3 id="F与Q查询"><a href="#F与Q查询" class="headerlink" title="F与Q查询"></a>F与Q查询</h3><h4 id="F"><a href="#F" class="headerlink" title="F"></a>F</h4><ul>
<li>能够直接获取到表中某个字段对应的数据</li>
<li>F不能够直接操作字符串</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查询卖出数大于库存数的书籍</span></span><br><span class="line">   <span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line">   res = models.Book.objects.<span class="built_in">filter</span>(sale__gt=F(<span class="string">&#x27;store&#x27;</span>))</span><br><span class="line">   print(res)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 2. 将所有书籍的价格提升500块</span></span><br><span class="line">   models.Book.objects.update(price=F(<span class="string">&#x27;price&#x27;</span>) + <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 3. 将所有书的名称后面加上爆款两个字</span></span><br><span class="line">   <span class="comment"># 在操作字符类型的数据的时候，F不能够直接做到字符串的拼接</span></span><br><span class="line">   <span class="keyword">from</span> django.db.models.functions <span class="keyword">import</span> Concat</span><br><span class="line">   <span class="keyword">from</span> django.db.models <span class="keyword">import</span> Value</span><br><span class="line">   <span class="comment"># models.Book.objects.update(title=F(&#x27;title&#x27;) + &#x27;爆款&#x27;)  # 所有的名称会全部变成空白</span></span><br><span class="line">   models.Book.objects.update(title=Concat(F(<span class="string">&#x27;title&#x27;</span>), Value(<span class="string">&#x27;爆款&#x27;</span>)))</span><br></pre></td></tr></table></figure>
<h4 id="Q"><a href="#Q" class="headerlink" title="Q"></a>Q</h4><ul>
<li>扩展搜索表达式</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.查询卖出数大于100或者价格小于600的书籍</span></span><br><span class="line"><span class="comment"># res = models.Book.objects.filter(maichu__gt=100,price__lt=600)  # filter括号内多个参数是and关系</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(Q(maichu__gt=<span class="number">100</span>), Q(price__lt=<span class="number">600</span>))  <span class="comment"># Q包裹逗号分割 还是and关系</span></span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(Q(maichu__gt=<span class="number">100</span>) | Q(price__lt=<span class="number">600</span>))  <span class="comment"># | or关系</span></span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(~Q(maichu__gt=<span class="number">100</span>) | Q(price__lt=<span class="number">600</span>))  <span class="comment"># ~ not关系</span></span><br><span class="line">print(res)  <span class="comment"># &lt;QuerySet []&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Q的高阶用法，将查询条件的左边变成字符串形式</span></span><br><span class="line">q = Q()</span><br><span class="line">q.connector = <span class="string">&#x27;or&#x27;</span>  <span class="comment"># 默认是and关系</span></span><br><span class="line">q.children.append((<span class="string">&#x27;maichu__gt&#x27;</span>, <span class="number">100</span>))</span><br><span class="line">q.children.append((<span class="string">&#x27;price__lt&#x27;</span>, <span class="number">600</span>))</span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(q)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<h2 id="django中如何开启事务"><a href="#django中如何开启事务" class="headerlink" title="django中如何开启事务"></a>django中如何开启事务</h2><ul>
<li>ACID<ul>
<li>原子性<ul>
<li>不可分割的最小单位</li>
</ul>
</li>
<li>一致性<ul>
<li>跟原子性是相辅相成</li>
</ul>
</li>
<li>隔离性<ul>
<li>事务之间互相不干扰</li>
</ul>
</li>
<li>持久性<ul>
<li>事务一旦确认永久生效</li>
</ul>
</li>
</ul>
</li>
<li>事务的回滚 <ul>
<li>rollback</li>
</ul>
</li>
<li>事务的确认<ul>
<li>commit</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django中如何简单地开启事务</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">        <span class="comment"># sql1</span></span><br><span class="line">        <span class="comment"># sql2</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># 在with代码快内书写的所有orm操作都是属于同一个事务</span></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(e)</span><br></pre></td></tr></table></figure>
<h2 id="orm字段及参数"><a href="#orm字段及参数" class="headerlink" title="orm字段及参数"></a>orm字段及参数</h2><h3 id="常用字段及参数"><a href="#常用字段及参数" class="headerlink" title="常用字段及参数"></a>常用字段及参数</h3><ol>
<li><p>AutoField：主键字段</p>
<ul>
<li>primary_key=True</li>
</ul>
<p>一般会自动创建，不需要手动设置</p>
</li>
<li><p>CharField：varchar</p>
<ul>
<li>verbose_name=字段的注释</li>
<li>max_length=长度</li>
<li>null=True可以为空</li>
<li>blank=True可以存空字符串（这两个有区别）</li>
<li>unique=True唯一</li>
</ul>
</li>
<li><p>IntegerField：int</p>
</li>
<li><p>BigIntegerField：bigint</p>
</li>
<li><p>DecimalField</p>
<ul>
<li>max_digits=允许的最大位数</li>
<li>decimal_places=小数的最大位数</li>
</ul>
</li>
<li><p>EmailFiled：varchar(254)</p>
</li>
<li><p>DateField：date</p>
<p>DateTimeField：datetime</p>
<ul>
<li>auto_now=每次修改数据时更新当前时间</li>
<li>auto_now_add=只在创建数据时记录当前时间</li>
</ul>
</li>
<li><p>BooleanField：Field</p>
<p>该字段传布尔值(False/True)，数据库里面存0/1</p>
</li>
<li><p>TextField：Field</p>
<p>该字段可以用来存大段内容(文章、博客…)，没有字数限制</p>
</li>
<li><p>FileField：Field</p>
<ul>
<li><p>upload_to = “/data/{file}”</p>
<p>给该字段传一个文件对象，会自动将文件保存到/data目录下，并将文件路径保存到数据库中</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>更多字段，直接参考博客:<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Dominic-Ji/p/9203990.html%EF%BC%8C%E5%90%8E%E7%BB%AD%E8%A1%A5%E5%85%A8">https://www.cnblogs.com/Dominic-Ji/p/9203990.html，后续补全</a></p>
</blockquote>
<h3 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义字段</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCharField</span>(<span class="params">models.Field</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, max_length, *args, **kwargs</span>):</span></span><br><span class="line">        self.max_length = max_length</span><br><span class="line">        <span class="comment"># 调用父类的init方法</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(max_length=max_length, *args, **kwargs)  <span class="comment"># 一定要是关键字的形式传入</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_type</span>(<span class="params">self, connection</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        返回真正的数据类型及各种约束条件</span></span><br><span class="line"><span class="string">        :param connection:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;char(%s)&#x27;</span> % self.max_length</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义字段使用</span></span><br><span class="line">myfield = MyCharField(max_length=<span class="number">16</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="外键字段及参数"><a href="#外键字段及参数" class="headerlink" title="外键字段及参数"></a>外键字段及参数</h3><ol>
<li><p>unique=True</p>
<p>ForeignKey(unique=True)等价于OneToOneField()</p>
</li>
<li><p>db_index=True</p>
<p>为此字段设置索引</p>
</li>
<li><p>to</p>
<p>设置要关联的表</p>
</li>
<li><p>to_field</p>
<p>设置要关联的表的字段，默认关联另外一张的主键字段，并且自动添加_id后缀</p>
</li>
<li><p>on_delete</p>
<p>当删除关联表中的数据时，当前表与其关联的行的行为。</p>
</li>
<li><p>related_name</p>
<p>反向查询使用的字段名，即代替 字段名__set</p>
</li>
<li><p>limit_choices_to</p>
<p>限制选择条件</p>
</li>
</ol>
<h2 id="数据库查询优化"><a href="#数据库查询优化" class="headerlink" title="数据库查询优化"></a>数据库查询优化</h2><h3 id="all"><a href="#all" class="headerlink" title="all()"></a>all()</h3><ul>
<li><p>orm语句的特点：惰性查询</p>
<p>如果仅仅只是书写了orm语句，在后面根本没有用到该语句所查询出来的参数，那么orm会自动识别，直接不执行。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = models.Book.objects.<span class="built_in">all</span>()  <span class="comment"># 此时并没有查询数据库</span></span><br><span class="line">print(res)  <span class="comment"># 要用数据了才会走数据库</span></span><br></pre></td></tr></table></figure>
<h3 id="only"><a href="#only" class="headerlink" title="only()"></a>only()</h3><blockquote>
<p>只取目标字段</p>
</blockquote>
<ul>
<li>拿到数据对象，这些对象本身只有only中提到的字段参数</li>
<li>如果调用没有包含的字段，则会重新回到数据库查询</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取书籍表中所有书的名字</span></span><br><span class="line">res = models.Book.objects.values(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> res:</span><br><span class="line">    print(d.get(<span class="string">&#x27;title&#x27;</span>))</span><br><span class="line"><span class="comment"># 实现获取数据对象，点title就能够拿到书名，并且没有其他字段</span></span><br><span class="line">res = models.Book.objects.only(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">print(res)  <span class="comment"># &lt;QuerySet [&lt;Book: 三国演义爆款&gt;, &lt;Book: 红楼梦爆款&gt;, &lt;Book: 论语爆款&gt;, &lt;Book: 聊斋爆款&gt;, &lt;Book: 老子爆款&gt;]&gt;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    print(i.title)  <span class="comment"># 点only括号内的字段，不会走数据库</span></span><br><span class="line">    print(i.price)  <span class="comment"># 点only括号内没有的字段，会重新走数据库查询而all()不需要走了</span></span><br></pre></td></tr></table></figure>
<h3 id="defer"><a href="#defer" class="headerlink" title="defer()"></a>defer()</h3><ul>
<li>defer与only刚好相反</li>
<li>defer括号内放的字段不在查询出来的对象里面，查询该字段需要重新走数据库</li>
<li>而如果查询的是非括号内的字段，则不需要走数据库了</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">res = models.Book.objects.defer(<span class="string">&#x27;title&#x27;</span>)  <span class="comment"># 对象除了没有title属性之外其他的都有</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    print(i.price)</span><br></pre></td></tr></table></figure>
<h3 id="select-related"><a href="#select-related" class="headerlink" title="select_related()"></a>select_related()</h3><blockquote>
<p>跨表操作</p>
</blockquote>
<ul>
<li><p>select_related内部先将book与publish连起来，然后一次性将大虚表的所有数据封装给查询出来的对象</p>
<p>这个时候对象无论是点击book表的数据还是publish表的数据都无需再走数据库查询了</p>
</li>
<li><p>select_related括号内只能放外键字段：一对多、一对一</p>
<p>不可以多对多</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   res = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">       print(i.publish.name)  <span class="comment"># 每循环一次就要走一次数据库查询</span></span><br><span class="line"></span><br><span class="line">   res = models.Book.objects.select_related(<span class="string">&#x27;authors&#x27;</span>)  <span class="comment"># INNER JOIN</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">       print(i.publish.name)  <span class="comment"># 每循环一次就要走一次数据库查询</span></span><br></pre></td></tr></table></figure>
<h3 id="prefetch-related"><a href="#prefetch-related" class="headerlink" title="prefetch_related()"></a>prefetch_related()</h3><ul>
<li><p>prefetch_related内部其实就是子查询</p>
<p>指把内部查询的结果作为外层查询的比较条件</p>
</li>
<li><p>两次查询，但不一定就比select_related差，要看实际情况</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">res = models.Book.objects.prefetch_related(<span class="string">&#x27;publish&#x27;</span>)  <span class="comment"># 子查询</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    print(i.publish.name)</span><br></pre></td></tr></table></figure>
<h3 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h3><p>当批量插入数据的时候，使用orm的<code>bulk_create</code>方法能够大幅减少操作时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ab_pl</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 1. 逐条插入</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        models.Book.objects.create(title=<span class="string">&#x27;第%s本书&#x27;</span> % i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 批量插入</span></span><br><span class="line">    book_list = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000</span>):</span><br><span class="line">        book_list.append(models.Book(title=<span class="string">&#x27;第%s本书&#x27;</span> % i))</span><br><span class="line">    models.Book.objects.bulk_create(book_list)</span><br><span class="line">    </span><br><span class="line">    book_queryset = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;ab_pl.html&#x27;</span>, <span class="built_in">locals</span>())</span><br></pre></td></tr></table></figure>
<h3 id="分页器"><a href="#分页器" class="headerlink" title="分页器"></a>分页器</h3><p>减少同一时间的数据展示量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ab_pl</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 分页</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cur_page = <span class="built_in">int</span>(request.GET.get(<span class="string">&#x27;cur_page&#x27;</span>, default=<span class="number">1</span>))  <span class="comment"># 如果获取不到当前页码，就展示第一页</span></span><br><span class="line">        per_page = <span class="built_in">int</span>(request.GET.get(<span class="string">&#x27;per_page&#x27;</span>, default=<span class="number">10</span>))  <span class="comment"># 每页展示多少条</span></span><br><span class="line">        start_page = <span class="built_in">int</span>((cur_page - <span class="number">1</span>) * per_page)  <span class="comment"># 起始位置</span></span><br><span class="line">        end_page = <span class="built_in">int</span>(cur_page * per_page)  <span class="comment"># 终止位置</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        start_page = <span class="number">0</span></span><br><span class="line">        end_page = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    book_list = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line">    page_queryset = book_list[start_page:end_page]</span><br><span class="line">    response = serializers.serialize(<span class="string">&#x27;json&#x27;</span>, page_queryset)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(response)</span><br></pre></td></tr></table></figure>


<h2 id="choices参数"><a href="#choices参数" class="headerlink" title="choices参数"></a>choices参数</h2><ul>
<li>只要某个字段的内容是可以枚举完全的，则可以采用choices参数：<ul>
<li>学历</li>
<li>客户来源</li>
<li>……</li>
</ul>
</li>
<li>元组套元组</li>
<li>需要保证数据库表中字段类型跟key的数据类型一致</li>
<li>在数据库中存的是key，value在orm中</li>
<li>不存在的key直接输出key，存在的key可以通过<code>get_字段_display()</code>转换成value输出</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -&gt; models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    age = models.IntegerField()</span><br><span class="line">    <span class="comment"># 性别</span></span><br><span class="line">    gender_choices = ((<span class="number">1</span>, <span class="string">&#x27;男&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;女&#x27;</span>))</span><br><span class="line">    gender = models.SmallIntegerField(choices=gender_choices)</span><br><span class="line"></span><br><span class="line">    score = models.CharField(choices=(</span><br><span class="line">        (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;优秀&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;良好&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;及格&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;不合格&#x27;</span>),</span><br><span class="line">    ), null=<span class="literal">True</span>)  <span class="comment"># 保证字段类型跟列举出来的元组第一个数据类型一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -&gt; test.py</span></span><br><span class="line">    <span class="comment"># 存的时候，没有列举出来的数字也能存，范围还是按照字段类型决定</span></span><br><span class="line">    models.User.objects.create(username=<span class="string">&#x27;jason&#x27;</span>, age=<span class="number">18</span>, gender=<span class="number">1</span>)</span><br><span class="line">    models.User.objects.create(username=<span class="string">&#x27;egon&#x27;</span>, age=<span class="number">85</span>, gender=<span class="number">2</span>)</span><br><span class="line">    models.User.objects.create(username=<span class="string">&#x27;tank&#x27;</span>, age=<span class="number">40</span>, gender=<span class="number">3</span>)</span><br><span class="line">    models.User.objects.create(username=<span class="string">&#x27;tony&#x27;</span>, age=<span class="number">45</span>, gender=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取</span></span><br><span class="line">    user_obj = models.User.objects.<span class="built_in">filter</span>(pk=<span class="number">1</span>).first()</span><br><span class="line">    print(user_obj.gender)  <span class="comment"># 数据库中存储的key</span></span><br><span class="line">    print(user_obj.get_gender_display())  <span class="comment"># 对于choices参数的字段，通过get_字段名_display()获取对应的值</span></span><br><span class="line">    user_obj = models.User.objects.<span class="built_in">filter</span>(pk=<span class="number">4</span>).first()</span><br><span class="line">    print(user_obj.get_gender_display())  <span class="comment"># 如果没有对应关系，那么返回字段存储的原key</span></span><br></pre></td></tr></table></figure>
<h2 id="MTV与MVC模型"><a href="#MTV与MVC模型" class="headerlink" title="MTV与MVC模型"></a>MTV与MVC模型</h2><ul>
<li>MTV：Django号称是MTV模型<ul>
<li>M：models</li>
<li>T：templates</li>
<li>V：views</li>
</ul>
</li>
<li>MVC：其实django本质也是MVC<ul>
<li>M：models</li>
<li>V：views</li>
<li>C：controller</li>
</ul>
</li>
<li>vue框架：MVVM模型</li>
</ul>
<h2 id="多对多三种创建方式"><a href="#多对多三种创建方式" class="headerlink" title="多对多三种创建方式"></a>多对多三种创建方式</h2><h3 id="全自动"><a href="#全自动" class="headerlink" title="全自动"></a>全自动</h3><ul>
<li>利用orm自动帮我们创建第三张关系表</li>
<li>优点：<ul>
<li>不需要写代码，非常方便</li>
<li>支持orm提供操作第三张关系表的方法</li>
</ul>
</li>
<li>不足之处：<ul>
<li>第三张关系表的扩展性极差：没有办法额外添加字段</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    authors = models.ManyToManyField(to=<span class="string">&#x27;Author&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="纯手动"><a href="#纯手动" class="headerlink" title="纯手动"></a>纯手动</h3><ul>
<li>优点：<ul>
<li>第三张表完全取决于你自己进行额外的扩展</li>
</ul>
</li>
<li>不足之处：<ul>
<li>需要写的代码较多</li>
<li>不能够使用orm提供的简单方法</li>
</ul>
</li>
</ul>
<p>不建议使用该方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book2Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    book_id = models.ForeignKey(to=<span class="string">&#x27;Book&#x27;</span>)</span><br><span class="line">    author_id = models.ForeignKey(to=<span class="string">&#x27;Author&#x27;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="半自动"><a href="#半自动" class="headerlink" title="半自动"></a>半自动</h3><ul>
<li>可以使用orm的正反向查询</li>
<li>但是没法使用add、set、remove、clear这四个方法</li>
<li>多对多表关系可以放在任何一方</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    authors = models.ManyToManyField(to=<span class="string">&#x27;Author&#x27;</span>,</span><br><span class="line">                                     through=<span class="string">&#x27;Book2Author&#x27;</span>,</span><br><span class="line">                                     through_fields=(<span class="string">&#x27;book&#x27;</span>,<span class="string">&#x27;author&#x27;</span>)</span><br><span class="line">                                     )  <span class="comment"># 将当前表名放在元组第一位</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="comment"># books = models.ManyToManyField(to=&#x27;Book&#x27;,</span></span><br><span class="line">    <span class="comment">#                                  through=&#x27;Book2Author&#x27;,</span></span><br><span class="line">    <span class="comment">#                                  through_fields=(&#x27;author&#x27;, &#x27;book&#x27;)</span></span><br><span class="line">    <span class="comment">#                                  )</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book2Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    book = models.ForeignKey(to=<span class="string">&#x27;Book&#x27;</span>)  <span class="comment"># 外键默认加id，这里不要加，包括through_fields</span></span><br><span class="line">    author = models.ForeignKey(to=<span class="string">&#x27;Author&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">NephrenCake</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nephrencake.gitee.io/2021/08/Django-Part4/">https://nephrencake.gitee.io/2021/08/Django-Part4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://nephrencake.gitee.io" target="_blank">浅幽丶奈芙莲的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/2021/08/Django-%E5%AE%8C%E7%BB%93%E7%9B%AE%E5%BD%95/%E4%BA%8Ced07.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/Django-Part5/"><img class="prev-cover" src="/2021/08/Django-%E5%AE%8C%E7%BB%93%E7%9B%AE%E5%BD%95/%E4%BA%8Ced07.jpg" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Django-Part5</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/Django-Part3/"><img class="next-cover" src="/2021/08/Django-%E5%AE%8C%E7%BB%93%E7%9B%AE%E5%BD%95/%E4%BA%8Ced07.jpg" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Django-Part3</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-Part4%E2%80%94%E2%80%94%E6%A8%A1%E5%9E%8B%E5%B1%82"><span class="toc-number">1.</span> <span class="toc-text">Django-Part4——模型层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="toc-number">1.1.</span> <span class="toc-text">测试脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-ORM"><span class="toc-number">1.2.</span> <span class="toc-text">Django ORM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B%E8%A1%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">创建模型表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E7%9A%84%E5%A2%9E-%E5%88%A0-%E6%94%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">字段的增&#x2F;删&#x2F;改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.3.</span> <span class="toc-text">创建表关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">单表操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">删</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A13%E6%9D%A1"><span class="toc-number">1.3.2.</span> <span class="toc-text">必知必会13条</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%86%85%E9%83%A8sql%E8%AF%AD%E5%8F%A5%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">查看内部sql语句的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.4.</span> <span class="toc-text">双下划线查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%A4%96%E9%94%AE%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">1.3.5.</span> <span class="toc-text">一对多外键增删改查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%A4%96%E9%94%AE%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">1.3.6.</span> <span class="toc-text">多对多外键增删改查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.</span> <span class="toc-text">多表查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%8F%8D%E5%90%91"><span class="toc-number">1.4.1.</span> <span class="toc-text">正反向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2-%E5%9F%BA%E4%BA%8E%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.2.</span> <span class="toc-text">子查询(基于对象的跨表查询)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%94%E8%A1%A8%E6%9F%A5%E8%AF%A2-%E5%9F%BA%E4%BA%8E%E5%8F%8C%E4%B8%8B%E5%88%92%E7%BA%BF%E7%9A%84%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.3.</span> <span class="toc-text">联表查询(基于双下划线的跨表查询)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2-aggregate"><span class="toc-number">1.4.4.</span> <span class="toc-text">聚合查询(aggregate)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2-annotate"><span class="toc-number">1.4.5.</span> <span class="toc-text">分组查询(annotate)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#F%E4%B8%8EQ%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.6.</span> <span class="toc-text">F与Q查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#F"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">F</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">Q</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#django%E4%B8%AD%E5%A6%82%E4%BD%95%E5%BC%80%E5%90%AF%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">django中如何开启事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#orm%E5%AD%97%E6%AE%B5%E5%8F%8A%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.</span> <span class="toc-text">orm字段及参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%AD%97%E6%AE%B5%E5%8F%8A%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.1.</span> <span class="toc-text">常用字段及参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E6%AE%B5"><span class="toc-number">1.6.2.</span> <span class="toc-text">自定义字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E5%AD%97%E6%AE%B5%E5%8F%8A%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.3.</span> <span class="toc-text">外键字段及参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text">数据库查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#all"><span class="toc-number">1.7.1.</span> <span class="toc-text">all()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#only"><span class="toc-number">1.7.2.</span> <span class="toc-text">only()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defer"><span class="toc-number">1.7.3.</span> <span class="toc-text">defer()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-related"><span class="toc-number">1.7.4.</span> <span class="toc-text">select_related()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prefetch-related"><span class="toc-number">1.7.5.</span> <span class="toc-text">prefetch_related()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="toc-number">1.7.6.</span> <span class="toc-text">批量插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E5%99%A8"><span class="toc-number">1.7.7.</span> <span class="toc-text">分页器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#choices%E5%8F%82%E6%95%B0"><span class="toc-number">1.8.</span> <span class="toc-text">choices参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MTV%E4%B8%8EMVC%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.9.</span> <span class="toc-text">MTV与MVC模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E4%B8%89%E7%A7%8D%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F"><span class="toc-number">1.10.</span> <span class="toc-text">多对多三种创建方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E8%87%AA%E5%8A%A8"><span class="toc-number">1.10.1.</span> <span class="toc-text">全自动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%AF%E6%89%8B%E5%8A%A8"><span class="toc-number">1.10.2.</span> <span class="toc-text">纯手动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E8%87%AA%E5%8A%A8"><span class="toc-number">1.10.3.</span> <span class="toc-text">半自动</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By NephrenCake</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">这里是浅幽丶奈芙莲的个人博客~</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>